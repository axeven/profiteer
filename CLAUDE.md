# CLAUDE.md

This file provides specific guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Context

For comprehensive project information, see **[README.md](README.md)** and **[docs/](docs/)** directory.

**Quick Summary**: Profiteer is a personal finance Android app built with Kotlin, Jetpack Compose, MVVM architecture, Firebase Auth, and Firestore, featuring a dual-wallet system with multi-currency support.

---

## Build Commands

### Development
- `./gradlew build` - Build the project
- `./gradlew assembleDebug` - Build debug APK
- `./gradlew testDebugUnitTest` - Run debug unit tests

### Code Quality
- `./gradlew lint` - Run Android lint checks
- `./gradlew test` - Run all unit tests

---

## Testing Requirements

- **All code changes MUST include tests** - No code without test coverage
- Test both happy path and error scenarios
- Use descriptive test names
- Mock external dependencies appropriately
- Run tests before committing

---

## Architecture Guidelines

### Core Patterns
- **MVVM** with Repository pattern for data access
- **Hilt** for dependency injection
- **StateFlow** and Compose State for reactive programming
- **Place business logic in ViewModels**, not in UI components

### Navigation
- **Pattern**: Stack-based navigation using `NavigationStack` class
- **Location**: `app/src/main/java/com/axeven/profiteerapp/navigation/NavigationStack.kt`
- **Key Operations**: `push()`, `pop()`, `canGoBack()`, `peekPrevious()`
- **Documentation**: See [Navigation Guidelines](docs/guides/navigation.md)

### Key Development Notes
- **Target SDK**: 36, **Min SDK**: 24, **Java**: 11
- Uses Gradle Version Catalogs (`gradle/libs.versions.toml`)
- Firebase must be in **Native Mode** (not Datastore Mode)

---

## Firebase Requirements

### Critical Setup
- **Firestore**: Must be Native Mode for real-time listeners
- **Authentication**: Google Sign-in with SHA-1 fingerprints configured
- **Security Rules**: User data isolation enforced

### üö® CRITICAL: Firestore Security Pattern

**Every Firestore query MUST include `userId` filter as FIRST condition:**

```kotlin
// ‚úÖ CORRECT
collection
  .whereEqualTo("userId", userId)
  .whereEqualTo("otherField", value)
  .get()

// ‚ùå FORBIDDEN
collection
  .whereEqualTo("walletId", walletId)  // Missing userId!
  .get()
```

**Checklist Before Writing ANY Firestore Query:**
- [ ] Function accepts `userId: String` parameter
- [ ] `.whereEqualTo("userId", userId)` is FIRST filter
- [ ] All callers pass correct userId

**Documentation**: See [Firebase Security Guidelines](docs/guides/firebase-security.md)

### Repository Error Handling

**üö® CRITICAL: Repositories NEVER depend on ViewModels**

```kotlin
// ‚úÖ CORRECT: Use domain error types
class MyRepository @Inject constructor(
    private val logger: Logger  // ‚úÖ Allowed
) {
    fun getData() = callbackFlow {
        addSnapshotListener { snapshot, error ->
            if (error != null) {
                close(RepositoryError.FirestoreListener(...))  // ‚úÖ Domain error
            }
        }
    }
}

// ‚ùå FORBIDDEN: Depend on ViewModels
class MyRepository @Inject constructor(
    private val sharedErrorViewModel: SharedErrorViewModel  // ‚ùå NEVER!
)
```

**Documentation**: See [Repository Error Handling](docs/guides/repository-error-handling.md)

---

## Code Organization

```
com.axeven.profiteerapp/
‚îú‚îÄ‚îÄ data/              # Data layer (models, repositories, DI)
‚îú‚îÄ‚îÄ ui/               # UI components (Jetpack Compose screens)
‚îú‚îÄ‚îÄ utils/            # Utility classes (formatters, validators)
‚îî‚îÄ‚îÄ viewmodel/        # ViewModels for business logic
```

---

## Business Logic & Validation

### Critical Business Rules
- **Balance Integrity**: Logical wallet balances = Physical wallet balances (sum)
- **Transfer Validation**: Same wallet type AND same currency required
- **Tag System**: Multiple tags per transaction, auto-completion after 3+ characters
- **Currency Conversion**: Default rates ‚Üí Monthly rates ‚Üí Warning system

### Tag System
- **Storage**: Lowercase normalized (`"food"`, `"travel"`)
- **Display**: Camel case formatted (`"Food"`, `"Travel"`)
- **Utilities**: `TagNormalizer` (storage), `TagFormatter` (display)
- **Documentation**: See [Tag System](docs/specs/features/tag-system.md)

### Wallet Sorting
- **Pattern**: Alphabetical sorting using `WalletSortingUtils`
- **Simple dropdowns**: `sortAlphabetically()` - single wallet type
- **Transfer dropdowns**: `sortByTypeAndName()` - mixed types
- **Documentation**: See [Wallet Dropdown Ordering](docs/plans/2025-10-30-wallet-dropdown-ordering.md)

### Report Filtering
- **Date Filtering**: Month/Year via `DateFilterPeriod`, `DateFilterUtils`
- **Wallet Filtering**: Per-wallet via `WalletFilter`, `WalletFilterUtils`
- **Chart Titles**: Generated by `ChartTitleUtils`
- **Documentation**: See implementation plans in `docs/plans/`

### Data Model Evolution
- **Transactions**: `affectedWalletIds` (modern) + `walletId` (legacy compatibility)
- **Tags**: `tags` array field + `category` field (backward compatibility)

---

## State Management

**üö® REQUIRED: Use consolidated state pattern**

```kotlin
// ‚úÖ CORRECT: Consolidated state
data class ScreenUiState(
    val dialogStates: DialogStates = DialogStates(),
    val formData: FormData = FormData(),
    val validationErrors: ValidationErrors = ValidationErrors()
) {
    val isFormValid: Boolean = /* derive from state */

    fun updateField(value: String): ScreenUiState {
        val newState = copy(formData = formData.copy(field = value))
        return newState.copy(validationErrors = validate(newState))
    }
}

// ‚ùå FORBIDDEN: Scattered state
var showDialog by remember { mutableStateOf(false) }
var titleText by remember { mutableStateOf("") }
```

**Documentation**: See [State Management Guidelines](docs/guides/state-management.md)

---

## Logging

**üö® REQUIRED: Use custom Logger, NEVER `android.util.Log`**

```kotlin
@HiltViewModel
class MyViewModel @Inject constructor(
    private val logger: Logger  // ‚úÖ Inject Logger
) : ViewModel() {
    fun performOperation() {
        logger.d("MyViewModel", "Starting operation")
        logger.e("MyViewModel", "Operation failed", exception)
    }
}
```

**Levels**: `d()` (debug), `i()` (info), `w()` (warning), `e()` (error)
**Documentation**: See [Logging Guidelines](docs/guides/logging.md)

---

## Development Best Practices

1. **Check README.md** for comprehensive project context
2. **Run tests** before committing any changes
3. **Follow existing patterns** for consistency
4. **Validate business rules** in all new implementations
5. **Use proper error handling** especially for Firebase operations
6. **Maintain backward compatibility** when modifying data models
7. **Verify balance integrity** in wallet/transaction operations
8. **üö® Follow Firebase security patterns** - userId filters mandatory
9. **üö® Follow repository patterns** - No ViewModel dependencies
10. **üö® Use consolidated state** - No scattered `mutableStateOf`
11. **üö® Use Logger injection** - Never `android.util.Log`

---

## AI Behavior Rules

- **NEVER ASSUME OR GUESS** - When in doubt, ask for clarification
- Never hallucinate libraries or functions ‚Äì only use verified libraries
- Always confirm file paths exist before referencing them
- Never delete/overwrite code unless explicitly instructed
- Keep CLAUDE.md updated when adding new patterns
- **Test your code** - No feature is complete without tests
- **Document your decisions** - Update plan docs upon completion

---

## Documentation & Explainability

- Update README.md when features/dependencies/setup changes
- Comment non-obvious code for mid-level developer understanding
- Add `# Reason:` comments for complex logic (explain why, not what)
- Every module should have a docstring
- Public functions must have complete docstrings

### Plan Documentation Maintenance
**CRITICAL**: When implementing from plan docs (`docs/plans/`):
- Mark completed tasks with ‚úÖ
- Update progress metrics
- Document actual vs. planned approaches
- Update status sections

---

## Quick Reference: Key Documentation

| Topic | Documentation |
|-------|---------------|
| **Documentation Hub** | [docs/README.md](docs/README.md) - Start here for all documentation |
| **AI Workflow** | [AI Agent Guide](docs/AI_AGENT_GUIDE.md) - Propose ‚Üí Plan ‚Üí Implement workflow |
| **Proposal Format** | [Proposal Format](docs/specs/PROPOSAL_FORMAT.md) - How to propose changes inline |
| **Navigation** | [Navigation Guidelines](docs/guides/navigation.md) |
| **Firebase Security** | [Firebase Security](docs/guides/firebase-security.md) |
| **Repository Errors** | [Error Handling](docs/guides/repository-error-handling.md) |
| **State Management** | [State Management](docs/guides/state-management.md) |
| **Logging** | [Logging Guidelines](docs/guides/logging.md) |
| **Tag System** | [Tag System Spec](docs/specs/features/tag-system.md) |
| **All Specifications** | [docs/specs/](docs/specs/) - Source of truth for features |
| **Implementation Plans** | [docs/plans/](docs/plans/) - TDD implementation checklists |

---

## üö® CRITICAL SECURITY CHECKLIST

**Before writing ANY Firestore query:**

1. ‚úÖ Does function accept `userId: String` parameter?
2. ‚úÖ Is `.whereEqualTo("userId", userId)` the FIRST filter?
3. ‚úÖ Are all callers passing correct userId?
4. ‚úÖ Does query follow security pattern in [Firebase Security Guidelines](docs/guides/firebase-security.md)?

**Security violations cause PERMISSION_DENIED errors!**
